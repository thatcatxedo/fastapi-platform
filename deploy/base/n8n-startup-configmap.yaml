apiVersion: v1
kind: ConfigMap
metadata:
  name: n8n-startup
  namespace: fastapi-platform
data:
  import-workflow.sh: |
    #!/bin/sh
    # Wait for n8n to be ready (postStart runs in parallel with main process)
    echo "Waiting for n8n to initialize..."
    sleep 15

    # Check if workflow already exists
    if n8n list:workflow 2>/dev/null | grep -q "Platform Chat"; then
      echo "Workflow already exists, skipping import"
    else
      echo "Importing chat workflow..."
      n8n import:workflow --input=/workflows/chat-workflow.json 2>&1 || true

      # Get workflow ID and activate it
      WORKFLOW_ID=$(n8n list:workflow 2>/dev/null | grep "Platform Chat" | cut -d'|' -f1)
      if [ -n "$WORKFLOW_ID" ]; then
        echo "Activating workflow $WORKFLOW_ID..."
        n8n update:workflow --id="$WORKFLOW_ID" --active=true 2>&1 || true
      fi
      echo "Workflow import complete"
    fi
