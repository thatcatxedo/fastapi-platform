apiVersion: apps/v1
kind: Deployment
metadata:
  name: n8n
  namespace: fastapi-platform
  labels:
    app: n8n
spec:
  replicas: 1
  selector:
    matchLabels:
      app: n8n
  template:
    metadata:
      labels:
        app: n8n
    spec:
      imagePullSecrets:
        - name: ghcr-auth
      containers:
        - name: n8n
          image: n8nio/n8n:latest
          ports:
            - containerPort: 5678
              name: http
          env:
            # Allow access to env vars in workflow expressions ($env)
            - name: N8N_BLOCK_ENV_ACCESS_IN_NODE
              value: "false"
            # Disable secure cookie for local HTTP access
            - name: N8N_SECURE_COOKIE
              value: "false"
            # Disable auth for internal webhook access
            - name: N8N_BASIC_AUTH_ACTIVE
              value: "false"
            # Webhook URL configuration
            - name: WEBHOOK_URL
              value: "http://n8n:5678/"
            - name: N8N_HOST
              value: "n8n"
            - name: N8N_PORT
              value: "5678"
            - name: N8N_PROTOCOL
              value: "http"
            # Auto-import workflows on startup
            - name: N8N_EXECUTIONS_DATA_SAVE_ON_SUCCESS
              value: "all"
            - name: N8N_EXECUTIONS_DATA_SAVE_ON_ERROR
              value: "all"
            # Use SQLite for simplicity (data in PVC)
            - name: DB_TYPE
              value: "sqlite"
            - name: DB_SQLITE_DATABASE
              value: "/home/node/.n8n/database.sqlite"
            # Anthropic API key from secret
            - name: ANTHROPIC_API_KEY
              valueFrom:
                secretKeyRef:
                  name: n8n-secrets
                  key: ANTHROPIC_API_KEY
                  optional: true
            # OpenAI API key from secret (optional fallback)
            - name: OPENAI_API_KEY
              valueFrom:
                secretKeyRef:
                  name: n8n-secrets
                  key: OPENAI_API_KEY
                  optional: true
            # Chat model configuration (defaults to Haiku if not set)
            - name: CHAT_MODEL
              valueFrom:
                configMapKeyRef:
                  name: platform-config
                  key: CHAT_MODEL
                  optional: true
            - name: CHAT_MAX_TOKENS
              valueFrom:
                configMapKeyRef:
                  name: platform-config
                  key: CHAT_MAX_TOKENS
                  optional: true
            # License key for enterprise features
            - name: N8N_LICENSE_ACTIVATION_KEY
              valueFrom:
                secretKeyRef:
                  name: n8n-secrets
                  key: N8N_LICENSE_ACTIVATION_KEY
                  optional: true
          volumeMounts:
            - name: n8n-data
              mountPath: /home/node/.n8n
            - name: workflow-config
              mountPath: /workflows
            - name: startup-script
              mountPath: /startup
          resources:
            requests:
              memory: "256Mi"
              cpu: "100m"
            limits:
              memory: "512Mi"
              cpu: "500m"
          readinessProbe:
            httpGet:
              path: /healthz
              port: 5678
            initialDelaySeconds: 10
            periodSeconds: 10
          livenessProbe:
            httpGet:
              path: /healthz
              port: 5678
            initialDelaySeconds: 30
            periodSeconds: 30
          # Import workflow after n8n starts
          lifecycle:
            postStart:
              exec:
                command:
                  - /bin/sh
                  - /startup/import-workflow.sh
      volumes:
        - name: n8n-data
          persistentVolumeClaim:
            claimName: n8n-data
        - name: workflow-config
          configMap:
            name: n8n-workflow
        - name: startup-script
          configMap:
            name: n8n-startup
            defaultMode: 0755
